<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AvoiderIo</title>
    <meta name="description" content="날아오는 장애물들을 피하세요!">
    <meta name="robots" content="index, follow">
    
    <!-- 보안 헤더 (X-Frame-Options 제거) -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    
    <!-- 파비콘 -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    
    <!-- 스타일시트 -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- 개발자 모드 스크립트 -->
    <script>
        // 개발자 모드 설정
        let DEVELOPER_MODE = true; // true로 변경하면 개발자 도구 허용

        // 개발자 모드 토글 함수 (콘솔에서 사용)
        window.toggleDevMode = function() {
            DEVELOPER_MODE = !DEVELOPER_MODE;
            console.log('🔧 개발자 모드:', DEVELOPER_MODE ? 'ON' : 'OFF');
            if (DEVELOPER_MODE) {
                console.log('✅ 개발자 도구가 허용되었습니다.');
                console.log('💡 사용 가능한 명령어:');
                console.log('   - debugLeaderboard() : 리더보드 디버그');
                console.log('   - exportLeaderboard() : 리더보드 내보내기');
                console.log('   - resetLeaderboard() : 리더보드 초기화');
                console.log('   - toggleDevMode() : 개발자 모드 끄기');
            }
        };

        // 개발자 도구 차단 (개발자 모드가 꺼져있을 때만).
        document.addEventListener('keydown', function(e) {
            if (!DEVELOPER_MODE) {
                // F12, Ctrl+Shift+I/J/C, Ctrl+U 차단
                if (e.key === 'F12' || 
                    (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key)) ||
                    (e.ctrlKey && e.key === 'U')) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🚫 개발자 도구가 차단되었습니다. 코나미 코드(↑↑↓↓←→←→)를 입력하세요.');
                    return false;
                }
            }
        });

        // 우클릭 차단 (개발자 모드가 꺼져있을 때만)
        document.addEventListener('contextmenu', function(e) {
            if (!DEVELOPER_MODE) {
                e.preventDefault();
                console.log('🚫 우클릭이 차단되었습니다. 코나미 코드(↑↑↓↓←→←→)를 입력하세요.');
                return false;
            }
        });

        // 드래그 차단
        document.addEventListener('dragstart', function(e) {
            if (!DEVELOPER_MODE) {
                e.preventDefault();
                return false;
            }
        });

        // 선택 차단
        document.addEventListener('selectstart', function(e) {
            if (!DEVELOPER_MODE) {
                e.preventDefault();
                return false;
            }
        });

        // 비밀 명령어로 개발자 모드 활성화 (코나미 코드)
        let secretSequence = [];
        const SECRET_CODE = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight'];

        document.addEventListener('keydown', function(e) {
            secretSequence.push(e.code);
            
            // 시퀀스가 너무 길면 앞부분 제거
            if (secretSequence.length > SECRET_CODE.length) {
                secretSequence.shift();
            }
            
            // 비밀 코드 확인 (코나미 코드)
            if (secretSequence.length === SECRET_CODE.length && 
                secretSequence.every((key, index) => key === SECRET_CODE[index])) {
                
                DEVELOPER_MODE = true;
                console.clear();
                console.log('🎮 비밀 코드 입력 완료! 개발자 모드 활성화!');
                console.log('✨ 코나미 코드: ↑↑↓↓←→←→');
                console.log('✅ 이제 우클릭이나 F12로 개발자 도구를 열 수 있습니다!');
                toggleDevMode();
                secretSequence = [];
            }
        });
    </script>
</head>
<body>
    <!-- 보안 경고 표시 영역 -->
    <div id="securityWarning" class="security-warning" style="display: none;">
        ⚠️ 비정상적인 활동이 감지되었습니다. 공정한 플레이를 위해 협조해주세요.
    </div>
    
    <!-- 게임 컨테이너 -->
    <div class="game-container" id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600" 
                aria-label="AvoiderIo 게임 화면"
                role="img">
            이 브라우저는 Canvas를 지원하지 않습니다. 최신 브라우저를 사용해주세요.
        </canvas>
        
        <!-- 일시정지 오버레이 -->
        <div class="pause-overlay" id="pauseOverlay" role="dialog" aria-labelledby="pauseTitle" aria-hidden="true">
            <div class="pause-menu">
                <h2 id="pauseTitle" class="pause-title">PAUSED</h2>
                <button class="pixel-button" onclick="resumeGame()" aria-label="게임 계속하기">
                    CONTINUE
                </button>
                <button class="pixel-button" onclick="goToMainMenu()" aria-label="메인 메뉴로 이동">
                    MAIN MENU
                </button>
            </div>
        </div>
        
        <!-- 게임오버 오버레이 -->
        <div class="game-over-overlay" id="gameOverOverlay" role="dialog" aria-labelledby="gameOverTitle" aria-hidden="true">
            <div class="game-over-menu">
                <h2 id="gameOverTitle" class="game-over-title">GAME OVER</h2>
                <div class="final-score-display" aria-label="최종 점수">
                    <span id="finalScore">0</span>
                </div>
                <div class="stats" role="group" aria-label="게임 통계">
                    <p>레벨: <span id="finalLevel" aria-label="도달한 레벨">1</span></p>
                    <p>생존 시간: <span id="finalTime" aria-label="생존한 시간">0</span>초</p>
                </div>
                <button class="pixel-button" onclick="startGame()" aria-label="게임 다시 시작">
                    RETRY
                </button>
                <button class="pixel-button" onclick="goToMainMenu()" aria-label="메인 메뉴로 이동">
                    MAIN MENU
                </button>
            </div>
        </div>
        
        <!-- 리더보드 오버레이 (aria-hidden 수정) -->
        <div class="leaderboard-overlay" id="leaderboardOverlay" role="dialog" aria-labelledby="leaderboardTitle" aria-hidden="true">
            <div class="leaderboard-menu">
                <h2 id="leaderboardTitle" class="leaderboard-title">LEADERBOARD</h2>
                <div class="leaderboard-list" id="leaderboardList" role="list" aria-label="순위표">
                    <!-- 리더보드 항목들이 여기에 동적으로 추가됩니다 -->
                </div>
                <button class="pixel-button" onclick="closeLeaderboard()" aria-label="리더보드 닫기">
                    CLOSE
                </button>
            </div>
        </div>
        
        <!-- 이름 입력 오버레이 -->
        <div class="name-input-overlay" id="nameInputOverlay" role="dialog" aria-labelledby="nameInputTitle" aria-hidden="true">
            <div class="name-input-menu">
                <h2 id="nameInputTitle" class="name-input-title">NEW RECORD!</h2>
                <p class="record-message">축하합니다! 새로운 기록을 달성했습니다!</p>
                <div class="record-stats" role="group" aria-label="달성한 기록">
                    <p>점수: <span id="recordScore" aria-label="달성한 점수">0</span></p>
                    <p>레벨: <span id="recordLevel" aria-label="도달한 레벨">1</span></p>
                    <p>생존 시간: <span id="recordTime" aria-label="생존한 시간">0</span>초</p>
                </div>
                <div class="name-input-container">
                    <label for="playerName">이름을 입력하세요:</label>
                    <input type="text" 
                           id="playerName" 
                           maxlength="15" 
                           placeholder="플레이어"
                           autocomplete="off"
                           spellcheck="false"
                           aria-label="플레이어 이름 입력"
                           aria-describedby="nameInputHelp">
                    <div id="nameInputHelp" class="sr-only">
                        최대 15자까지 입력 가능하며, 특수문자는 자동으로 제거됩니다.
                    </div>
                </div>
                <button class="pixel-button" onclick="submitRecord()" aria-label="기록 등록">
                    등록
                </button>
                <button class="pixel-button secondary" onclick="skipRecord()" aria-label="기록 등록 건너뛰기">
                    건너뛰기
                </button>
            </div>
        </div>
        
        <!-- 하단 컨트롤 안내 -->
        <div class="bottom-controls" role="complementary" aria-label="게임 조작법">
            <kbd>WASD</kbd>/<kbd>방향키</kbd>: 이동 | <kbd>ESC</kbd>: 일시정지 | <kbd>Space</kbd>: 게임 시작
        </div>
    </div>

    <!-- 숨겨진 접근성 정보 -->
    <div class="sr-only" id="gameInstructions">
        이 게임은 장애물을 피해 최대한 오래 생존하는 게임입니다. 
        WASD 키나 방향키로 플레이어를 움직여 가시, 레이저, 폭탄을 피하세요.
        하트 아이템을 먹으면 생명력이 회복됩니다.
    </div>

    <!-- JavaScript 파일들 -->
    <script src="config.js"></script>
    <script src="utils.js"></script>
    <script src="sound.js"></script>
    <script src="leaderboard.js"></script>
    <script src="arena.js"></script>
    <script src="effects.js"></script>
    <script src="obstacle.js"></script>
    <script src="obstacle_spawner.js"></script>
    <script src="player.js"></script>
    <script src="game.js"></script>
    <script src="main.js"></script>
    
    <!-- 에러 처리 및 로깅 -->
    <script>
        window.addEventListener('error', function(e) {
            console.error('게임 오류:', e.error);
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('처리되지 않은 Promise 거부:', e.reason);
        });
        
        // 게임 로드 완료 체크
        window.addEventListener('load', function() {
            console.log('AvoiderIo 게임이 성공적으로 로드되었습니다.');
            console.log('🎮 개발자 모드: 코나미 코드(↑↑↓↓←→←→)로 활성화');
            
            // 사운드 초기화를 위한 첫 번째 클릭 이벤트
            document.addEventListener('click', function initAudio() {
                if (typeof soundManager !== 'undefined') {
                    // 오디오 컨텍스트 초기화
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        if (audioContext.state === 'suspended') {
                            audioContext.resume();
                        }
                    } catch (error) {
                        console.warn('오디오 컨텍스트 초기화 실패:', error);
                    }
                }
                // 한 번만 실행
                document.removeEventListener('click', initAudio);
            });
            
            // 보안 경고 표시 함수
            window.showSecurityWarning = function() {
                const warning = document.getElementById('securityWarning');
                if (warning) {
                    warning.style.display = 'block';
                    setTimeout(() => {
                        warning.style.display = 'none';
                    }, 5000);
                }
            };
            
            // 네트워크 상태 모니터링
            function updateNetworkStatus() {
                if (!navigator.onLine) {
                    console.warn('오프라인 상태입니다. 리더보드 기능이 제한될 수 있습니다.');
                }
            }
            
            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
            
            // 초기 네트워크 상태 확인
            updateNetworkStatus();
        });
        
        // 페이지 가시성 변경 감지
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('페이지가 백그라운드로 이동');
            } else {
                console.log('페이지가 포그라운드로 복귀');
            }
        });
        
        // 브라우저 호환성 체크
        function checkBrowserCompatibility() {
            const features = {
                canvas: !!document.createElement('canvas').getContext,
                localStorage: typeof Storage !== 'undefined',
                fetch: typeof fetch !== 'undefined',
                promise: typeof Promise !== 'undefined'
            };
            
            const unsupported = Object.keys(features).filter(key => !features[key]);
            
            if (unsupported.length > 0) {
                console.warn('지원되지 않는 기능:', unsupported);
                alert('이 브라우저는 일부 기능을 지원하지 않습니다. 최신 브라우저를 사용해주세요.');
            }
        }
        
        // 호환성 체크 실행
        checkBrowserCompatibility();
    </script>
</body>
</html>