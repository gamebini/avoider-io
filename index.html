<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AvoiderIo - 무료 온라인 피하기 게임</title>
    
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YS3B0F2RL5"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        
        // GA4 설정 (측정 ID를 실제 받은 ID로 교체하세요)
        gtag('config', 'G-YS3B0F2RL5', {
            // 쿠키 설정
            cookie_flags: 'SameSite=None;Secure',
            // 개인정보 보호 설정
            anonymize_ip: true,
            // 사이트 내 검색 추적
            site_speed_sample_rate: 100,
            // 커스텀 설정
            custom_map: {
                'custom_parameter_1': 'game_level',
                'custom_parameter_2': 'final_score'
            }
        });
        
        // 게임 관련 이벤트 추적 함수들
        function trackGameStart() {
            gtag('event', 'game_start', {
                event_category: 'game',
                event_label: 'new_game',
                value: 1
            });
        }
        
        function trackGameOver(score, level, time) {
            gtag('event', 'game_over', {
                event_category: 'game',
                event_label: 'game_completed',
                value: score,
                custom_parameter_1: level,
                custom_parameter_2: score,
                game_time: time
            });
        }
        
        function trackLevelUp(level) {
            gtag('event', 'level_up', {
                event_category: 'game',
                event_label: 'level_progression',
                value: level
            });
        }
        
        function trackHighScore(score, isNewRecord) {
            gtag('event', 'high_score', {
                event_category: 'achievement',
                event_label: isNewRecord ? 'new_record' : 'high_score',
                value: score
            });
        }
        
        function trackLeaderboardView() {
            gtag('event', 'leaderboard_view', {
                event_category: 'engagement',
                event_label: 'leaderboard_opened'
            });
        }
        
        function trackSoundToggle(enabled) {
            gtag('event', 'sound_toggle', {
                event_category: 'settings',
                event_label: enabled ? 'sound_on' : 'sound_off'
            });
        }
    </script>
    
    <!-- 필수 SEO 메타 태그 -->
    <meta name="description" content="AvoiderIo - 장애물을 피해 최대한 오래 생존하는 무료 온라인 게임입니다. 가시, 레이저, 폭탄을 피하며 최고 기록에 도전하세요!">
    <meta name="keywords" content="AvoiderIo, 피하기 게임, 무료 게임, 온라인 게임, 웹 게임, 아케이드 게임, 생존 게임, 브라우저 게임">
    <meta name="robots" content="index, follow">
    
    <!-- Google Search Console 인증 태그 (받은 코드로 교체) -->
    <!-- <meta name="google-site-verification" content="여기에_받은_코드_입력" /> -->
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://avoiderio.xyz">
    
    <!-- 기본 파비콘 -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    
    <!-- 보안 헤더 -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    
    <!-- 스타일시트 -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- 개발자 모드 스크립트 -->
    <script>
        let DEVELOPER_MODE = true;

        window.toggleDevMode = function() {
            DEVELOPER_MODE = !DEVELOPER_MODE;
            console.log('🔧 개발자 모드:', DEVELOPER_MODE ? 'ON' : 'OFF');
        };

        document.addEventListener('keydown', function(e) {
            if (!DEVELOPER_MODE) {
                if (e.key === 'F12' || 
                    (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key)) ||
                    (e.ctrlKey && e.key === 'U')) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🚫 개발자 도구가 차단되었습니다. 코나미 코드(↑↑↓↓←→←→)를 입력하세요.');
                    return false;
                }
            }
        });

        document.addEventListener('contextmenu', function(e) {
            if (!DEVELOPER_MODE) {
                e.preventDefault();
                console.log('🚫 우클릭이 차단되었습니다. 코나미 코드(↑↑↓↓←→←→)를 입력하세요.');
                return false;
            }
        });

        // 코나미 코드
        let secretSequence = [];
        const SECRET_CODE = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight'];

        document.addEventListener('keydown', function(e) {
            secretSequence.push(e.code);
            
            if (secretSequence.length > SECRET_CODE.length) {
                secretSequence.shift();
            }
            
            if (secretSequence.length === SECRET_CODE.length && 
                secretSequence.every((key, index) => key === SECRET_CODE[index])) {
                
                DEVELOPER_MODE = true;
                console.clear();
                console.log('🎮 비밀 코드 입력 완료! 개발자 모드 활성화!');
                toggleDevMode();
                secretSequence = [];
            }
        });
    </script>
</head>
<body>
    <!-- SEO용 숨겨진 헤더 -->
    <header style="position: absolute; left: -9999px;">
        <h1>AvoiderIo - 무료 온라인 피하기 게임</h1>
        <p>장애물을 피해 최대한 오래 생존하는 무료 온라인 게임입니다. WASD 키나 방향키로 플레이어를 움직여 가시, 레이저, 폭탄을 피하세요.</p>
    </header>

    <!-- 보안 경고 표시 영역 -->
    <div id="securityWarning" class="security-warning" style="display: none;">
        ⚠️ 비정상적인 활동이 감지되었습니다. 공정한 플레이를 위해 협조해주세요.
    </div>
    
    <!-- 게임 컨테이너 -->
    <div class="game-container" id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600" 
                aria-label="AvoiderIo 게임 화면"
                role="img">
            이 브라우저는 Canvas를 지원하지 않습니다. 최신 브라우저를 사용해주세요.
        </canvas>
        
        <!-- 일시정지 오버레이 -->
        <div class="pause-overlay" id="pauseOverlay" role="dialog" aria-labelledby="pauseTitle" aria-hidden="true">
            <div class="pause-menu">
                <h2 id="pauseTitle" class="pause-title">PAUSED</h2>
                <button class="pixel-button" onclick="resumeGame()" aria-label="게임 계속하기">
                    CONTINUE
                </button>
                <button class="pixel-button" onclick="goToMainMenu()" aria-label="메인 메뉴로 이동">
                    MAIN MENU
                </button>
            </div>
        </div>
        
        <!-- 게임오버 오버레이 -->
        <div class="game-over-overlay" id="gameOverOverlay" role="dialog" aria-labelledby="gameOverTitle" aria-hidden="true">
            <div class="game-over-menu">
                <h2 id="gameOverTitle" class="game-over-title">GAME OVER</h2>
                <div class="final-score-display" aria-label="최종 점수">
                    <span id="finalScore">0</span>
                </div>
                <div class="stats" role="group" aria-label="게임 통계">
                    <p>레벨: <span id="finalLevel" aria-label="도달한 레벨">1</span></p>
                    <p>생존 시간: <span id="finalTime" aria-label="생존한 시간">0</span>초</p>
                </div>
                <button class="pixel-button" onclick="startGame()" aria-label="게임 다시 시작">
                    RETRY
                </button>
                <button class="pixel-button" onclick="goToMainMenu()" aria-label="메인 메뉴로 이동">
                    MAIN MENU
                </button>
            </div>
        </div>
        
        <!-- 리더보드 오버레이 -->
        <div class="leaderboard-overlay" id="leaderboardOverlay" role="dialog" aria-labelledby="leaderboardTitle" aria-hidden="true">
            <div class="leaderboard-menu">
                <h2 id="leaderboardTitle" class="leaderboard-title">LEADERBOARD</h2>
                <div class="leaderboard-list" id="leaderboardList" role="list" aria-label="순위표">
                    <!-- 리더보드 항목들이 여기에 동적으로 추가됩니다 -->
                </div>
                <button class="pixel-button" onclick="closeLeaderboard()" aria-label="리더보드 닫기">
                    CLOSE
                </button>
            </div>
        </div>
        
        <!-- 이름 입력 오버레이 -->
        <div class="name-input-overlay" id="nameInputOverlay" role="dialog" aria-labelledby="nameInputTitle" aria-hidden="true">
            <div class="name-input-menu">
                <h2 id="nameInputTitle" class="name-input-title">NEW RECORD!</h2>
                <p class="record-message">축하합니다! 새로운 기록을 달성했습니다!</p>
                <div class="record-stats" role="group" aria-label="달성한 기록">
                    <p>점수: <span id="recordScore" aria-label="달성한 점수">0</span></p>
                    <p>레벨: <span id="recordLevel" aria-label="도달한 레벨">1</span></p>
                    <p>생존 시간: <span id="recordTime" aria-label="생존한 시간">0</span>초</p>
                </div>
                <div class="name-input-container">
                    <label for="playerName">이름을 입력하세요:</label>
                    <input type="text" 
                           id="playerName" 
                           maxlength="15" 
                           placeholder="플레이어"
                           autocomplete="off"
                           spellcheck="false"
                           aria-label="플레이어 이름 입력">
                </div>
                <button class="pixel-button" onclick="submitRecord()" aria-label="기록 등록">
                    등록
                </button>
                <button class="pixel-button secondary" onclick="skipRecord()" aria-label="기록 등록 건너뛰기">
                    건너뛰기
                </button>
            </div>
        </div>
        
        <!-- 하단 컨트롤 안내 -->
        <div class="bottom-controls" role="complementary" aria-label="게임 조작법">
            <kbd>WASD</kbd>/<kbd>방향키</kbd>: 이동 | <kbd>ESC</kbd>: 일시정지 | <kbd>Space</kbd>: 게임 시작
        </div>
    </div>

    <!-- JavaScript 파일들 -->
    <script src="config.js"></script>
    <script src="utils.js"></script>
    <script src="sound.js"></script>
    <script src="leaderboard.js"></script>
    <script src="arena.js"></script>
    <script src="effects.js"></script>
    <script src="obstacle.js"></script>
    <script src="obstacle_spawner.js"></script>
    <script src="player.js"></script>
    <script src="game.js"></script>
    <script src="main.js"></script>
    
    <!-- 에러 처리 및 로깅 -->
    <script>
        window.addEventListener('error', function(e) {
            console.error('게임 오류:', e.error);
            
            // Analytics에 오류 이벤트 전송
            if (typeof gtag !== 'undefined') {
                gtag('event', 'exception', {
                    description: e.error ? e.error.toString() : 'Unknown error',
                    fatal: false
                });
            }
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('처리되지 않은 Promise 거부:', e.reason);
            
            // Analytics에 Promise 거부 이벤트 전송
            if (typeof gtag !== 'undefined') {
                gtag('event', 'exception', {
                    description: 'Unhandled Promise Rejection: ' + e.reason,
                    fatal: false
                });
            }
        });
        
        window.addEventListener('load', function() {
            console.log('AvoiderIo 게임이 성공적으로 로드되었습니다.');
            
            // 페이지 로드 완료 이벤트
            if (typeof gtag !== 'undefined') {
                gtag('event', 'page_view', {
                    page_title: 'AvoiderIo Game',
                    page_location: window.location.href
                });
            }
            
            document.addEventListener('click', function initAudio() {
                if (typeof soundManager !== 'undefined') {
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        if (audioContext.state === 'suspended') {
                            audioContext.resume();
                        }
                    } catch (error) {
                        console.warn('오디오 컨텍스트 초기화 실패:', error);
                    }
                }
                document.removeEventListener('click', initAudio);
            });
        });
        
        // 사용자 세션 시간 추적
        let sessionStartTime = Date.now();
        window.addEventListener('beforeunload', function() {
            const sessionDuration = Math.round((Date.now() - sessionStartTime) / 1000);
            if (typeof gtag !== 'undefined') {
                gtag('event', 'session_duration', {
                    event_category: 'engagement',
                    value: sessionDuration
                });
            }
        });
    </script>
</body>
</html>